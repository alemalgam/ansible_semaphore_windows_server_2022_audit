---
- name: Distribute SSH key to Windows hosts over SSH
  hosts: windows
  gather_facts: no
  vars:
    ansible_remote_tmp: '/tmp/ansible'  # Use a Unix-style tmp path for SSH
  tasks:
    - name: Ensure .ssh directory exists
      shell: 'mkdir -p ~/.ssh'

    - name: Ensure authorized_keys file exists
      shell: 'touch ~/.ssh/authorized_keys'

    - name: Add SSH public key if not present
      shell: |
        PUBKEY="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        grep -qxF "$PUBKEY" ~/.ssh/authorized_keys || echo "$PUBKEY" >> ~/.ssh/authorized_keys
