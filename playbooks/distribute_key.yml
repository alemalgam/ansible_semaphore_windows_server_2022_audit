---
- name: Distribute SSH key to Windows hosts over SSH (PowerShell)
  hosts: windows
  gather_facts: no
  become: yes
  become_method: runas
  become_user: anadmin
  tasks:
    - name: Ensure .ssh directory exists
      win_shell: |
        if (!(Test-Path "$env:USERPROFILE\.ssh")) {
            New-Item -ItemType Directory -Path "$env:USERPROFILE\.ssh"
        }

    - name: Ensure authorized_keys file exists
      win_shell: |
        if (!(Test-Path "$env:USERPROFILE\.ssh\authorized_keys")) {
            New-Item -ItemType File -Path "$env:USERPROFILE\.ssh\authorized_keys"
        }

    - name: Add SSH public key if not present
      win_shell: |
        $pubKey = "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        $authFile = "$env:USERPROFILE\.ssh\authorized_keys"
        if (-not (Select-String -Path $authFile -Pattern $pubKey)) {
            Add-Content -Path $authFile -Value $pubKey
        }
